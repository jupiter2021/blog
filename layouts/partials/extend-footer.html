<script>
// TOC Scroll Spy
(function () {
  const tocLinks = document.querySelectorAll('.toc-right nav#TableOfContents a');
  if (!tocLinks.length) return;

  const headings = [];
  tocLinks.forEach(link => {
    const id = decodeURIComponent(link.getAttribute('href').slice(1));
    const el = document.getElementById(id);
    if (el) headings.push({ el, link });
  });

  if (!headings.length) return;

  let activeLink = null;
  const OFFSET = 160; // account for fixed header

  function updateActive() {
    let current = null;
    for (let i = headings.length - 1; i >= 0; i--) {
      const rect = headings[i].el.getBoundingClientRect();
      if (rect.top <= OFFSET) {
        current = headings[i];
        break;
      }
    }
    // If scrolled to top, nothing active
    if (!current && window.scrollY < 100) {
      if (activeLink) {
        activeLink.classList.remove('toc-active');
        activeLink = null;
      }
      return;
    }
    // Default to first heading if scrolled past top
    if (!current) current = headings[0];

    if (activeLink === current.link) return;
    if (activeLink) activeLink.classList.remove('toc-active');
    current.link.classList.add('toc-active');
    activeLink = current.link;
  }

  let ticking = false;
  window.addEventListener('scroll', function () {
    if (!ticking) {
      requestAnimationFrame(function () {
        updateActive();
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });

  updateActive();
})();

// Lazy-load videos: set src from data-src when near viewport
(function () {
  const videos = document.querySelectorAll('video[data-src]');
  if (!videos.length) return;

  const observer = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        const video = entry.target;
        video.src = video.getAttribute('data-src');
        video.removeAttribute('data-src');
        video.preload = 'metadata';
        observer.unobserve(video);
      }
    });
  }, { rootMargin: '200px 0px' }); // start loading 200px before entering viewport

  videos.forEach(function (video) { observer.observe(video); });
})();

// Lazy-load Live Photos: only init when near viewport
(function () {
  const livePhotos = document.querySelectorAll('[data-live-photo]');
  if (!livePhotos.length) return;

  const observer = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        const el = entry.target;
        el.setAttribute('data-proactively-loads-video', 'true');
        observer.unobserve(el);
      }
    });
  }, { rootMargin: '300px 0px' });

  livePhotos.forEach(function (el) { observer.observe(el); });
})();

// medium-zoom 打开时锁定页面滚动，防止移动端缩放手势误触关闭
(function () {
  const body = document.body;
  const observer = new MutationObserver(function () {
    const overlay = document.querySelector('.medium-zoom-overlay');
    if (overlay) {
      body.classList.add('zoom-overlay-active');
    } else {
      body.classList.remove('zoom-overlay-active');
    }
  });
  observer.observe(body, { childList: true });
})();
</script>
