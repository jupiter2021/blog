<script>
// TOC Scroll Spy
(function () {
  const tocLinks = document.querySelectorAll('.toc-right nav#TableOfContents a');
  if (!tocLinks.length) return;

  const headings = [];
  tocLinks.forEach(link => {
    const id = decodeURIComponent(link.getAttribute('href').slice(1));
    const el = document.getElementById(id);
    if (el) headings.push({ el, link });
  });

  if (!headings.length) return;

  let activeLink = null;
  const OFFSET = 160; // account for fixed header

  function updateActive() {
    let current = null;
    for (let i = headings.length - 1; i >= 0; i--) {
      const rect = headings[i].el.getBoundingClientRect();
      if (rect.top <= OFFSET) {
        current = headings[i];
        break;
      }
    }
    // If scrolled to top, nothing active
    if (!current && window.scrollY < 100) {
      if (activeLink) {
        activeLink.classList.remove('toc-active');
        activeLink = null;
      }
      return;
    }
    // Default to first heading if scrolled past top
    if (!current) current = headings[0];

    if (activeLink === current.link) return;
    if (activeLink) activeLink.classList.remove('toc-active');
    current.link.classList.add('toc-active');
    activeLink = current.link;
  }

  let ticking = false;
  window.addEventListener('scroll', function () {
    if (!ticking) {
      requestAnimationFrame(function () {
        updateActive();
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });

  updateActive();
})();

// Lazy-load videos: set src from data-src when near viewport
(function () {
  const videos = document.querySelectorAll('video[data-src]');
  if (!videos.length) return;

  const observer = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        const video = entry.target;
        video.src = video.getAttribute('data-src');
        video.removeAttribute('data-src');
        video.preload = 'metadata';
        observer.unobserve(video);
      }
    });
  }, { rootMargin: '200px 0px' }); // start loading 200px before entering viewport

  videos.forEach(function (video) { observer.observe(video); });
})();

// Live Photo 播放器：长按/触摸播放视频，松开恢复图片
// 纯 HTML5 实现，兼容微信浏览器、iOS Safari 等所有环境
(function () {
  var players = document.querySelectorAll('.livephoto-player');
  if (!players.length) return;

  // 懒加载视频：进入视口前 300px 时开始 preload metadata
  var lazyObserver = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        var video = entry.target.querySelector('video');
        if (video && video.preload === 'none') {
          video.preload = 'metadata';
        }
        lazyObserver.unobserve(entry.target);
      }
    });
  }, { rootMargin: '300px 0px' });

  players.forEach(function (player) {
    lazyObserver.observe(player);

    var video = player.querySelector('video');
    var holdTimer = null;
    var isPlaying = false;

    function startPlay() {
      if (isPlaying) return;
      // 预加载整个视频以保证流畅播放
      video.preload = 'auto';
      var p = video.play();
      if (p && p.catch) p.catch(function () {});
      player.classList.add('is-playing');
      isPlaying = true;
    }

    function stopPlay() {
      if (!isPlaying) return;
      player.classList.remove('is-playing');
      video.pause();
      video.currentTime = 0;
      isPlaying = false;
      if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; }
    }

    // 桌面端：hover 即播放
    player.addEventListener('mouseenter', function () {
      holdTimer = setTimeout(startPlay, 100);
    });
    player.addEventListener('mouseleave', function () {
      stopPlay();
    });

    // 移动端：长按播放，松开停止
    player.addEventListener('touchstart', function (e) {
      holdTimer = setTimeout(startPlay, 180);
    }, { passive: true });
    player.addEventListener('touchend', stopPlay);
    player.addEventListener('touchcancel', stopPlay);
  });
})();

// medium-zoom 打开时锁定页面滚动，防止移动端缩放/滑动手势误触关闭
(function () {
  var savedScrollY = 0;
  var body = document.body;

  function preventTouch(e) { e.preventDefault(); }

  var observer = new MutationObserver(function () {
    var overlay = document.querySelector('.medium-zoom-overlay');
    var isActive = body.classList.contains('zoom-overlay-active');

    if (overlay && !isActive) {
      // 保存滚动位置，用 position:fixed 冻结页面（iOS Safari 最可靠的方式）
      savedScrollY = window.scrollY;
      body.classList.add('zoom-overlay-active');
      body.style.position = 'fixed';
      body.style.top = '-' + savedScrollY + 'px';
      body.style.width = '100%';

      // 拦截 overlay 和图片上的 touchmove，防止产生 scroll 事件
      overlay.addEventListener('touchmove', preventTouch, { passive: false });
      var zoomedImg = document.querySelector('.medium-zoom-image--opened');
      if (zoomedImg) {
        zoomedImg.addEventListener('touchmove', preventTouch, { passive: false });
      }
    } else if (!overlay && isActive) {
      // 恢复滚动位置
      body.classList.remove('zoom-overlay-active');
      body.style.position = '';
      body.style.top = '';
      body.style.width = '';
      window.scrollTo(0, savedScrollY);
    }
  });

  observer.observe(body, { childList: true });
})();
</script>
